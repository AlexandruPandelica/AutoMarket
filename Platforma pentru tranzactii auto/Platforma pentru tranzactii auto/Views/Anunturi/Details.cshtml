@model Platforma_pentru_tranzactii_auto.Models.Anunturi
@using Microsoft.AspNetCore.Identity
@inject UserManager<Utilizator> UserManager

@{
    ViewData["Title"] = "Detalii anunț";
}

<main class="container py-5 mt-4">

    <div class="mb-4">
        <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
            ← Înapoi la listă
        </a>
    </div>

    <div class="card shadow-lg border-0 rounded-4">
        <div class="row g-0">

            <div class="col-lg-5">
                <div class="position-relative h-100">

                    @if (Model.GalerieImagini != null && Model.GalerieImagini.Any())
                    {
                        <div id="carouselAnunt" class="carousel slide h-100" data-bs-ride="carousel">

                            <div class="carousel-indicators">
                                @for (int i = 0; i < Model.GalerieImagini.Count; i++)
                                {
                                    <button type="button" data-bs-target="#carouselAnunt" data-bs-slide-to="@i" class="@(i==0 ? "active" : "")"></button>
                                }
                            </div>

                            <div class="carousel-inner h-100" style="border-radius: 1.25rem 0 0 1.25rem; overflow: hidden;">
                                @for (int i = 0; i < Model.GalerieImagini.Count; i++)
                                {
                                    var img = Model.GalerieImagini[i];
                                    <div class="carousel-item h-100 @(i==0 ? "active" : "")">
                                        <img src="data:image/*;base64,@(Convert.ToBase64String(img.Imagine))"
                                             class="d-block w-100 h-100"
                                             style="object-fit: cover; min-height: 400px;"
                                             alt="Imagine @i">
                                    </div>
                                }
                            </div>

                            <button class="carousel-control-prev" type="button" data-bs-target="#carouselAnunt" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carouselAnunt" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    }
                    else if (Model.Imagine_Anunt != null && Model.Imagine_Anunt.Length > 0)
                    {
                        <img src="data:image/*;base64,@(Convert.ToBase64String(Model.Imagine_Anunt))"
                             class="img-fluid w-100 h-100"
                             style="object-fit: cover; border-radius: 1.25rem 0 0 1.25rem; min-height: 300px;"
                             alt="Imagine principală" />
                    }
                    else
                    {
                        <div class="d-flex align-items-center justify-content-center h-100 w-100 bg-light text-muted"
                             style="min-height: 300px; border-radius: 1.25rem 0 0 1.25rem;">
                            Fără imagine
                        </div>
                    }

                    <span class="badge bg-primary position-absolute"
                          style="bottom: 16px; left: 16px; padding: 0.6rem 1.1rem; border-radius: 999px; font-size: 0.95rem; z-index: 10;">
                        @Model.Pret.ToString("N0") €
                    </span>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card-body p-4 p-md-5">

                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="h3 fw-bold mb-1">
                                @Model.Marca @Model.Model
                            </h1>
                            <p class="text-muted mb-0">
                                @if (!string.IsNullOrWhiteSpace(Model.Locatie))
                                {
                                    <span><i class="bi bi-geo-alt"></i> @Model.Locatie</span>
                                }
                            </p>
                        </div>

                        @if (User.Identity.IsAuthenticated && UserManager.GetUserId(User) == Model.UserId.ToString())
                        {
                            <a asp-action="Edit" asp-route-id="@Model.ID_Anunt" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-pencil-square"></i> Editează
                            </a>
                        }
                    </div>

                    <hr />

                    <div class="row gy-3 mb-4">
                        <div class="col-6 col-md-4">
                            <div class="text-muted small">An fabricație</div>
                            <div class="fw-semibold">@Model.An_Fabricatie</div>
                        </div>
                        <div class="col-6 col-md-4">
                            <div class="text-muted small">Kilometraj</div>
                            <div class="fw-semibold">@Model.Kilometraj.ToString("N0") km</div>
                        </div>
                        <div class="col-6 col-md-4">
                            <div class="text-muted small">Data postării</div>
                            <div class="fw-semibold">@Model.Data_Postarii.ToLocalTime().ToString("dd.MM.yyyy")</div>
                        </div>
                        <div class="col-6 col-md-4">
                            <div class="text-muted small">Vizualizări</div>
                            <div class="fw-semibold"><i class="bi bi-eye"></i> @Model.Nr_Vizualizari</div>
                        </div>
                        <div class="col-6 col-md-4">
                            <div class="text-muted small">Vânzător</div>
                            <div class="fw-semibold">@(Model.User?.Email ?? "Necunoscut")</div>
                            @if (User.Identity.IsAuthenticated && UserManager.GetUserId(User) != Model.UserId.ToString())
                            {
                                <button type="button" class="btn btn-success btn-sm mt-2 w-100 rounded-pill"
                                        data-bs-toggle="modal" data-bs-target="#modalContact">
                                    <i class="bi bi-envelope-fill"></i> Contactează
                                </button>
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(Model.Descriere))
                    {
                        <div class="mb-4">
                            <h5 class="fw-semibold mb-2">Descriere</h5>
                            <p class="text-muted mb-0" style="white-space: pre-line;">
                                @Model.Descriere
                            </p>
                        </div>
                    }

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <a asp-action="Index" class="btn btn-outline-secondary">
                            ← Înapoi la listă
                        </a>

                        @if (User.Identity.IsAuthenticated && UserManager.GetUserId(User) == Model.UserId.ToString())
                        {
                            <div>
                                <a asp-action="Delete" asp-route-id="@Model.ID_Anunt" class="btn btn-outline-danger btn-sm">
                                    Șterge Anunț
                                </a>
                            </div>
                        }
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-lg-8 mx-auto">

            <h3 class="fw-bold mb-4">
                Recenzii și Întrebări 💬
                <span class="text-muted fs-5">(@(Model.Comentari?.Count() ?? 0))</span>
            </h3>

            @if (User.Identity.IsAuthenticated)
            {
                <div class="card shadow-sm border-0 mb-5 bg-light">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3">Lasă o recenzie</h5>

                        <form asp-action="AdaugaComentariu" method="post" id="form-comentariu">
                            <input type="hidden" name="idAnunt" value="@Model.ID_Anunt" />

                            <div class="mb-3">
                                <label class="form-label small text-muted">Nota ta:</label>
                                <select name="recenzie" class="form-select w-auto">
                                    <option value="5">⭐⭐⭐⭐⭐ - Excelent</option>
                                    <option value="4">⭐⭐⭐⭐ - Bun</option>
                                    <option value="3">⭐⭐⭐ - Mediu</option>
                                    <option value="2">⭐⭐ - Slab</option>
                                    <option value="1">⭐ - Foarte slab</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <textarea name="textComentariu" class="form-control" rows="3"
                                          placeholder="Scrie părerea ta sau pune o întrebare vânzătorului..." required></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary rounded-pill px-4">
                                <i class="bi bi-send"></i> Postează
                            </button>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning mb-5">
                    Trebuie să fii <strong>autentificat</strong> pentru a lăsa un comentariu.
                    <a href="/Identity/Account/Login" class="alert-link">Loghează-te aici</a>.
                </div>
            }

            <div class="d-flex flex-column gap-3" id="lista-comentarii">
                @if (Model.Comentari != null && Model.Comentari.Any())
                {
                    @foreach (var comm in Model.Comentari.OrderByDescending(c => c.DataComentariu))
                    {
                        <partial name="_Comentariu" model="comm" />
                    }
                }
                else
                {
                    <div id="no-comments-msg" class="text-center text-muted py-4">
                        <i class="bi bi-chat-square-text display-4 mb-3 d-block opacity-25"></i>
                        <p>Încă nu există recenzii pentru acest anunț. Fii tu primul!</p>
                    </div>
                }
            </div>

        </div>
    </div>
</main>


<div class="modal fade" id="modalContact" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Trimite un mesaj vânzătorului</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form asp-controller="Mesaje" asp-action="Trimite" method="post">
                <div class="modal-body p-4">
                    <input type="hidden" name="anuntId" value="@Model.ID_Anunt" />
                    <input type="hidden" name="destinatarId" value="@Model.UserId" />

                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small">Subiect</label>
                        <input type="text" class="form-control bg-light" value="Interesat de: @Model.Marca @Model.Model" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small">Mesajul tău</label>
                        <textarea name="continut" class="form-control" rows="4" placeholder="Bună, mai este valabil anunțul? M-ar interesa..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Renunță</button>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-send-fill"></i> Trimite
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 shadow" role="alert" style="z-index: 1050;">
        <i class="bi bi-check-circle-fill me-2"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@section Scripts {
    <script>
        // --- 1. SCRIPT ADĂUGARE COMENTARIU ---
        document.getElementById('form-comentariu')?.addEventListener('submit', function(e) {
            e.preventDefault();

            var form = this;
            var formData = new FormData(form);
            var submitBtn = form.querySelector('button[type="submit"]');
            var originalBtnText = submitBtn.innerHTML;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Se trimite...';

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                }
            })
            .then(response => {
                if (response.ok) return response.text();
                throw new Error('Eroare rețea');
            })
            .then(html => {
                var container = document.getElementById('lista-comentarii');
                var noCommentsMsg = document.getElementById('no-comments-msg');
                if(noCommentsMsg) noCommentsMsg.remove();

                container.insertAdjacentHTML('afterbegin', html);
                form.reset();
            })
            .catch(error => alert("Eroare la postare."))
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        });

        // --- 2. SCRIPT ȘTERGERE COMENTARIU (NOU) ---
        // Folosim Event Delegation pentru că butoanele de ștergere apar dinamic
        document.getElementById('lista-comentarii')?.addEventListener('submit', function(e) {

            // Verificăm dacă formularul trimis este unul de ștergere
            if (e.target.classList.contains('delete-comment-form')) {
                e.preventDefault(); // Oprim refresh-ul paginii

                if (!confirm('Sigur vrei să ștergi acest comentariu?')) {
                    return;
                }

                var form = e.target;
                var commentId = form.getAttribute('data-comment-id');
                var formData = new FormData(form);

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // Căutăm cardul comentariului după ID
                        var card = document.getElementById('comment-' + commentId);
                        if (card) {
                            // Animație de ștergere
                            card.style.transition = "all 0.5s ease";
                            card.style.opacity = "0";
                            card.style.transform = "translateX(20px)";

                            // Eliminăm elementul după ce se termină animația
                            setTimeout(() => {
                                card.remove();

                                // Opțional: Actualizăm contorul de comentarii
                                var counterSpan = document.querySelector('h3 span.text-muted');
                                if(counterSpan) {
                                    var text = counterSpan.innerText;
                                    var count = parseInt(text.replace(/\D/g,'')); // Extragem numărul
                                    if(!isNaN(count) && count > 0) {
                                        counterSpan.innerText = '(' + (count - 1) + ')';
                                    }
                                }
                            }, 500);
                        }
                    } else {
                        alert('Nu s-a putut șterge comentariul.');
                    }
                })
                .catch(error => console.error('Eroare:', error));
            }
        });
    </script>

    <style>
        .fade-in-animation {
            animation: slideDownFade 0.5s ease-out forwards;
        }

        @@keyframes slideDownFade {
            from

        {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }
    </style>
}